\chapter{Pipelines}\label{chapter-pipelines}

\begin{enumerate}
  \item \textbf{Vertex}: The majority of transformation pipeline happens here,
  \textbf{except W2V}
  \begin{itemize}
    \item Programmable through shader
  \end{itemize}

  \item \textbf{Rasterization}: produces a set of fragments (which are
  potential pixels); fragments have
  \begin{itemize}
    \item Location in frame buffer (screen location)
    \item Color
    \item Depth
  \end{itemize}

  \item \textbf{Fragment}: the fragment shader would finalize the color
  produced by the rasterization stage
  \begin{itemize}
    \item Not pixels: each fragment has a 2D location in a raster and a color;
    final value is found by appliying hidden surface removal and possibly
    compositing to a set of fragments
    \item Programmable through shader
  \end{itemize}
\end{enumerate}

\section{Transformation Pipeline}

  Transforming model coordinate system to viewport coordinate system
  (\textbf{note that transformations occur from right to left})

  \begin{itemize}
    \item Mostly done on GPU (except \textbf{W2V})
    \item GPU parts are done through the vertex shader
    \item Can also handle colors
  \end{itemize}

  \begin{equation}
    \begin{bmatrix}
      x_{s} \\
      y_{s} \\
      0 \\
      1
    \end{bmatrix}
    =
    \begin{bmatrix}
      \text{W2V}
    \end{bmatrix}
    \begin{bmatrix}
      \text{Projection}
    \end{bmatrix}
    \begin{bmatrix}
      \text{View}
    \end{bmatrix}
    \begin{bmatrix}
      \text{Model}
    \end{bmatrix}
    \begin{bmatrix}
      x_{m} \\
      y_{m} \\
      z_{m} \\
      1
    \end{bmatrix}
  \end{equation}

  \begin{itemize}
    \item The \textbf{model matrix} map local object coordinates to
    world coordinates (ex. rotation)
    \item Given a camera looking down the z-axis from the origin,
    the \textbf{view matrix} map world coordinates to camera coordinates,
    where camera sits at the origin
    \item The \textbf{projection matrix} map camera coordinates to canonical
    view volume (basically 2D)
    \item The \textbf{W2V (window to view) matrix} map canonical view volume
    to screen space
  \end{itemize}

  Every transformations except W2V transformation happen in vertex
  processing stage

  \subsection{In Unity}

    \begin{itemize}
      \item Transform component on a camera is the view matrix
      \item Camera settings are used to create
      \begin{itemize}
        \item Projection matrix
        \item Viewport matrix
      \end{itemize}
    \end{itemize}

  \subsection{Projection}

    Projection refers to the process of reducing dimensionality. There are two
    modes of projection

    \begin{itemize}
      \item \textbf{Orthographic}: toss out the z component
      \item \textbf{Perspective}: scale decreases as distance increases
    \end{itemize}

    \subsubsection{Perspective Projection}

      \paragraph{Equation}
      \begin{align}
        \frac{y_{\text{clip}}}{d} &= \frac{y_{\text{view}}}{-z_{\text{view}}} \\
        y_{\text{clip}}
        &= d\frac{y_ {\text{view}}}{-z_{\text{view}}} \\
        &= \frac{y_{\text{view}}}{-z_{\text{view}} / d}
      \end{align}

      \begin{itemize}
        \item The equation applies in situations where
        \begin{itemize}
          \item The \textbf{eyes} are \textbf{centered at the origin}
          \item The \textbf{view} is in \textbf{negative z direction}
          \item The clip is between the eyes and the view
        \end{itemize}

        \item $ d $: distance from eyes to the screen (clip)
        \item This equation also applies to $ x $ and $ y $
      \end{itemize}

      \paragraph{Matrix}
      \begin{equation}
        P =
        \begin{bmatrix}
          \frac{n}{2} & 0 & 0 & 0 \\
          0 & \frac{n}{t} & 0 & 0 \\
          0 & 0 & \frac{-f}{f - n} & \frac{-fn}{f - n} \\
          0 & 0 & -1 & 0 \\
        \end{bmatrix}
      \end{equation}

      \begin{itemize}
        \item $ r $: right
        \item $ t $: top
        \item $ n $: near
        \item $ f $: far
      \end{itemize}

      \href{http://www.songho.ca/opengl/gl_projectionmatrix.html}{Deriving
      the matrix}

\section{Hidden Surface Removal}

  \begin{itemize}
    \item \textbf{Painter's algorithm}: draw farther object first
    \begin{itemize}
      \item Expensive to sort
      \item Depth cycle
    \end{itemize}

    \item \textbf{Z-Buffer}: keep a z buffer on pixels, while drawing,
    only write to pixel if the object being drawn has a z value that is
    closer than the z value of the pixel
    \begin{itemize}
      \item More popular today; not used in the past for memory issues
      \item If two z values are too close, it's hard to determine which is
      closer
    \end{itemize}
  \end{itemize}
