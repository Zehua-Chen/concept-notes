\chapter{Overview}

\newglossaryentry{ray}
{
  name=ray,
  description={an origin and a direction}
}

\newglossaryentry{ray-casting}
{
  name=ray casting,
  description={if an ray intersects with an object}
}

\newacronym{bvh}{BVH}{Bounding Volume Hierarchy}

\begin{itemize}
  \item \textbf{\Gls{ray}}: \Glsdesc{ray}
  \item \textbf{\Gls{ray-casting}}: \Glsdesc{ray-casting}
  \item Camera shoots rays into the screen.
  \item In naive ray tracing, if ray hits light, then a pixel is lit.
  \item In more complex ray tracing, multiple rays, each is slightly different
  from others, are shot. The result of all the rays lead to the values of one
  pixel. This can also be used to perform anti-aliasing
  \item Using \acrfull{bvh} leads to $ O\left( \log n \right) $ runtime
\end{itemize}

\section{Rays}

  \begin{equation}
    P\left( t \right) = O + td
  \end{equation}

  $ P\left( t \right) $ is a point on the ray; $ t $ is the time; $ O $ is
  the origin, and $ d $ is the direction

  \begin{itemize}
    \item Rays travel in straight lines
    \item Rays do not interfere with other rays
    \item Rays travel from light source to eyes; \textbf{physics is the same under
    path reversal (reciprocity)}
  \end{itemize}

  \subsection{Types of Rays}

    \begin{enumerate}
      \item Primary rays: rays shot from pixels
      \item Secondary rays
      \item Shadow rays
      \item Light rays
    \end{enumerate}

  \subsection{Screen Space, World Space Pixel Coordinates}

\section{Basic Ray Tracing}

  \begin{algorithm}[H]
    \caption{Basic Ray Tracing}
    define objects\;
    define materials for objects\;
    define light sources\;
    define window\;
    \ForEach{pixel}{
      construct ray through the pixel\;
      compute the intersection of the ray with each object\;
      find the closest intersection\;
      \If{there is an intersection} {
        use lights and materials to compute pixel color\;
      }
      \Else{
        pixel is set to background color\;
      }
    }
  \end{algorithm}

\section{Shooting Rays}

  \subsection{Screen Space to World Space Pixel Coordinates}

    \begin{align}
      x_{w} &= s\left( c - \frac{h_{res}}{2} + 0.5 \right) \\
      y_{w} &= s\left( r - \frac{v_{res}}{2} + 0.5 \right)
    \end{align}

    \begin{itemize}
      \item $ c, r $: screen space coordinates of pixels; $ c $ is the column,
      $ r $ is the row
      \item $ s $: pixel extent
      \item $ x_{w}, y_{w} $: coordinate in world space of the pixel center
      \item $ z_{w} $ is typically $ 0 $
    \end{itemize}

  \subsection{Orthographic}

    \begin{align}
      O &= \left( x_{w}, y_{w}, z_{w} \right) \\
      d &= \left( 0, 0, -1 \right)
    \end{align}

    Rays have the same direction as negative-z and use their world space
    coordinates as origins

  \subsection{Perspective}

    \begin{align}
      e &= \left( e_{w}, e_{w}, e_{w} \right) \\
      O &= e  \\
      d &= \left( x_{w}, y_{w}, z_{w} \right) - e
    \end{align}

\section{Intersection}

  Given an implicit surface equation $ f\left( x, y, z \right) = 0 $, we
  want to find a point $ p $ that is on the surface,
  i.e. $ f\left( p \right) = 0 $. Since $ p = O + dt $, we are looking for
  $ t $ in $ f\left( O + td \right) = 0 $.

  If $ t < 0 $, then intersection is behind the screen

  \textbf{Robustly}: a solution is resistant to error and produces similar
  result for small changes in input

  \subsection{Plane}

    \begin{align}
      Ax + By + Cz + D &= 0 \\
      \left( p - a \right) \cdot n = 0
    \end{align}

    $ a $ is a \textbf{point in space} and $ n $ is the \textbf{normal vector}
    of the plane with its origin at $ a $

    Given a ray $ O + td $ we can solve for a $ t $, which gives us the
    point of intersection.

    \begin{align*}
      \left( p - a \right) \cdot n &= 0 \\
      \left( \left( O + td \right) - a \right) \cdot n &= 0 \\
      \frac{\left( \left( a - O \right) \cdot n \right)}{d \cdot n} &= t
    \end{align*}

    If the ray and the plane is parallel, then $ d \cdot n = 0 $

  \subsection{Sphere}

    Spheres are defined by

    \begin{equation}
      \left( P - G \right) \cdot \left( P - G \right) = r^{2}
    \end{equation}

    $ P $ is a \textbf{point is space}, $ G $ is the \textbf{center of sphere},
    and $ r $ is the \textbf{radius of sphere}

    Replace $ P $ with $ O + td $ and let $ f = O - G  $

    \begin{align}
      \left( d \cdot d \right) t^{2}
        + 2 \left( f \cdot d \right) t
        + f \cdot f - r^{2}
      &= 0 \\
      a t^{2} + bt + c &= \\
      \frac{-b \pm \sqrt{b^{2} - 4ac}}{2a} &= t_{0, 1} \\
      \frac{P_{0} - G}{r} &= n
    \end{align}

    \begin{itemize}
      \item $ t_{0, 1} $: rays will have two intersection points
      \item $ b^{2} - 4ac < 0 $: ray does not intersect with sphere
      \item $ b^{2} - 4ac > 0 $: ray intersects with sphere
      \item $ b^{2} - 4ac = 0 $: ray touches sphere on the surface
    \end{itemize}

    \subsubsection{Diminished Significance}

      \paragraph{Problem}
      \begin{itemize}
        \item 32 bit float point can result in error; caused by
        \textbf{diminished} significance
        \begin{itemize}
          \item Ex. small spheres that are very far away
        \end{itemize}

        $ c = f \cdot f - r^{2}  $ is problematic, if $ f $ is big and $ r $ is
        small, diminished significance would occur. If a sphere is more than
        \begin{equation}
          2^{12} r = 4096 r
        \end{equation}
        away from the ray origin, then radius has no impact on intersection
        solution.
      \end{itemize}

      \paragraph{Solution} \textbf{Hearn Baker Method}
      \begin{align}
        b^{2} - 4ac &= 4a \left( \frac{b^{2}}{4a} - c \right) \\
        &= 4d^{2} \left( r^{2} - \left( f - \left( f \cdot \hat{d} \right) \hat{d} \right)^{2} \right)
      \end{align}

    \subsubsection{Catastrophic Cancellation}

      \paragraph{Problem}
      \begin{itemize}
        \item Occurs when substracting nearly equal numbers
        \item Many significant bits eliminate each other
        \item Few meaningful bits remain
      \end{itemize}

      We have approximations

      \begin{align}
        \tilde{x} &= x \left( 1 + \delta_{x} \right) \\
        \tilde{y} &= y \left( 1 + \delta_{y} \right)
      \end{align}

      Small relative errors

      \begin{align}
        \left| \delta_{x} \right| &= \frac{\left| x - \tilde{x} \right|}{\left| x \right|} \\
        \left| \delta_{y} \right| &= \frac{\left| y - \tilde{y} \right|}{\left| y \right|}
      \end{align}

      Relative error of the difference can be arbitarrily large

      \begin{equation}
        \left| \frac{x \delta_{x} - y \delta_{y}}{x - y} \right|
      \end{equation}

      This can happen when $ b \approx \sqrt{b^{2} - 4ac} $

      \paragraph{Solution} Catastrophic cancellation only happens to one of the
      two quadratic solutions. Can be fixed using $ t_{0} t_{1} = \frac{c}{a} $

      \begin{equation}
        \begin{cases}
          t_{0} = \frac{c}{q} \\
          t_{1} = \frac{q}{a}
        \end{cases}
      \end{equation}

      where $ q = \frac{1}{2}\left( b + \sign\left( b \right) \sqrt{b^{2} - 4ac} \right) $
      $ \sign $ function returns 1 if $ b > 0 $ and $ - 1 $ otherwise
\section{Multi-Sampling}

  \newglossaryentry{aliasing}
  {
    name=aliasing,
    description={when a function has been reconstructed as a
    different function; especially when high frequency details are lost and
    represented as low frequency}
  }

  \begin{itemize}
    \item \textbf{\Gls{aliasing}}: \Glsdesc{aliasing};
    \item In a ray tracer, we are dividing images into squares and reconstruct
    a function that tells us how light is passing through the square
    \item Pixels have both discrete ($ d $) and continuous ($ c $) locations
    \begin{equation}
      c = d + \frac{1}{2}
    \end{equation}
    $ \left( 3, 5 \right) $ is located at $ \left( 3.5, 5.5 \right) $

    \item Good sampling is uniform
  \end{itemize}

  \subsection{Regular Sampling}

    \newglossaryentry{regular-sampling}
    {
      name=regular sampling,
      description={shoot rays through a $ n $ by $ n $ grid of subpixels.
      Color of a pixel is the average color of the subpixels}
    }

    \textbf{\Gls{regular-sampling}}: \glsdesc{regular-sampling}

    \begin{itemize}
      \item Expensive to perform
      \item Does not solve moire pattern
    \end{itemize}

  \subsection{Random Sampling}

    \newglossaryentry{random-sampling}
    {
      name=random sampling,
      description={rather than shooting rays through a grid, shoot rays from
      random locations in the pixel}
    }

    \textbf{\Gls{random-sampling}}: \glsdesc{random-sampling}

    \begin{itemize}
      \item Reduce in noisy result
      \item People alias noisy to aliasing visually
    \end{itemize}

  \subsection{Jittered Sampling}

    \newglossaryentry{jittered-sampling}
    {
      name=jittered sampling,
      description={create a grid and randomly generate a sample in each cell}
    }

    \textbf{\Gls{jittered-sampling}}: \glsdesc{jittered-sampling}

    \begin{itemize}
      \item Better than random, but still poorly distributed
    \end{itemize}

  \subsection{n-rooks Sampling}

    \newglossaryentry{nrooks-sampling}
    {
      name=n-rooks sampling,
      description={create a grid but create one sample in all rows and columns}
    }

    \textbf{\Gls{nrooks-sampling}}: \glsdesc{nrooks-sampling}

    \begin{itemize}
      \item Good 1D distribution
      \item Poor 2D distribution
    \end{itemize}

  \subsection{Multi-Jittered Sampling}

    \newglossaryentry{multi-jittered-sampling}
    {
      name=multi-jittered sampling,
      description={create a $ n \times n $ grid, known as \textbf{fine grid};
      then create a $ \sqrt{n} \times \sqrt{n} $ coarse grid each
      containing $ n $ fine grid's cells.
      Make sure each coarse grid cell contains one sample
      and the sample has unique fine grid row and column.}
    }

    \textbf{\Gls{multi-jittered-sampling}}: \glsdesc{multi-jittered-sampling}

    \begin{itemize}
      \item Good 1D projection from rock condition
      \item Good 2D projection from stratification
    \end{itemize}
